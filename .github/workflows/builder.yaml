name: ğŸ› ï¸ Builder

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  release:
    types:
      - published

jobs:
  lint:
    runs-on: ubuntu-latest
    name: ğŸ“ Lint repository files
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v2

      - name: âœ… Run ShellCheck
        uses: ludeeus/action-shellcheck@master

      - name: âœ¨ Run JQ
        run: |
          shopt -s globstar
          cat **/*.json | jq '.'

  base-os:
    name: ğŸ”¨ Build ${{ matrix.tag }}
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - "alpine/base"
          - "debian/base"
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v2

      - name: ğŸ“ƒ Get changed files
        if: github.event_name != 'release'
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: ğŸ› ï¸ Run build action
        uses: ./.github/build-action
        with:
          tag: ${{ matrix.tag }}
          user: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN  }}

  base-os-s6:
    name: ğŸ”¨ Build ${{ matrix.tag }}
    needs: base-os
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - "alpine-s6/base"
          - "debian-s6/base"
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v2

      - name: ğŸ“ƒ Get changed files
        if: github.event_name != 'release'
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: ğŸ› ï¸ Run build action
        uses: ./.github/build-action
        with:
          tag: ${{ matrix.tag }}
          user: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN }}

  base-runtime:
    name: ğŸ”¨ Build ${{ matrix.tag }}
    needs: base-os
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - "alpine/node"
          - "alpine/python"
          - "debian/node"
          - "debian/python"
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v2

      - name: ğŸ“ƒ Get changed files
        if: github.event_name != 'release'
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: ğŸ› ï¸ Run build action
        uses: ./.github/build-action
        with:
          tag: ${{ matrix.tag }}
          user: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN  }}

  base-runtime-s6:
    name: ğŸ”¨ Build ${{ matrix.tag }}
    needs: base-runtime
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - "alpine-s6/node"
          - "alpine-s6/python"
          - "debian-s6/node"
          - "debian-s6/python"
    steps:
      - name: ğŸ“¥ Checkout the repository
        uses: actions/checkout@v2

      - name: ğŸ“ƒ Get changed files
        if: github.event_name != 'release'
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: ğŸ› ï¸ Run build action
        uses: ./.github/build-action
        with:
          tag: ${{ matrix.tag }}
          user: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN  }}

  devcontainer:
    name:  ğŸ”¨ Build ${{ matrix.tag }}
    needs: base-runtime
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - "devcontainer/frontend"
          - "devcontainer/integration"
          - "devcontainer/node"
          - "devcontainer/python"
    steps:
      - name: ğŸ“¦ Checkout the repository
        uses: actions/checkout@v2

      - name: ğŸ“ƒ Get changed files
        if: github.event_name != 'release'
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: ğŸ› ï¸ Run build action
        uses: ./.github/build-action
        with:
          tag: ${{ matrix.tag }}
          user: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN  }}

  lastrun:
    name:  ğŸ”¨ Build ${{ matrix.tag }}
    needs: devcontainer
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - "devcontainer/generic"
    steps:
      - name: ğŸ“¦ Checkout the repository
        uses: actions/checkout@v2

      - name: ğŸ“ƒ Get changed files
        if: github.event_name != 'release'
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: ğŸ› ï¸ Run build action
        uses: ./.github/build-action
        with:
          tag: ${{ matrix.tag }}
          user: ${{ github.repository_owner }}
          token: ${{ secrets.GITHUB_TOKEN  }}